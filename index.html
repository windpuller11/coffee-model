<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>äº‘å’–åº„å›­ç§æ¤é¡¹ç›®ï½œç°é‡‘æµæµ‹ç®—çœ‹æ¿</title>
  <style>
    :root {
      --bg:#0b1220;
      --muted:#8ea0c4;
      --text:#eaf0ff;
      --line:#1d2a47;
      --accent:#6ea8fe;
      --active:#162548;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   "PingFang SC","Hiragino Sans GB","Microsoft YaHei", Arial, sans-serif;
      background: radial-gradient(1200px 800px at 30% -10%, rgba(110,168,254,.25), transparent 55%),
                  radial-gradient(900px 600px at 90% 0%, rgba(245,197,66,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap { max-width: 1280px; margin: 0 auto; padding: 20px 18px 50px; }
    header {
      display:flex; justify-content:space-between; align-items:flex-end; gap:16px;
      margin-bottom:14px;
    }
    h1 { margin:0; font-size: 22px; letter-spacing:.2px; }
    .sub { color: var(--muted); font-size: 12px; line-height: 1.45; }
    .pill {
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px;
      border:1px solid var(--line); border-radius:999px;
      background: rgba(255,255,255,.04); color: var(--muted);
      font-size: 12px; white-space:nowrap;
    }

    .grid { display:grid; grid-template-columns: 460px 1fr; gap: 14px; }
    @media (max-width: 1050px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #cfe0ff;
      letter-spacing:.2px;
    }

    .kpis {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 12px 0 10px;
    }
    @media (max-width: 1050px) { .kpis { grid-template-columns: repeat(2, 1fr); } }

    .kpiBtn {
      width: 100%;
      text-align:left;
      padding: 12px 12px 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor: pointer;
    }
    .kpiBtn:hover { background: rgba(255,255,255,.06); }
    .kpiBtn.active { background: rgba(22,37,72,.75); border-color: rgba(110,168,254,.6); }
    .kpiBtn .label { color: var(--muted); font-size: 12px; }
    .kpiBtn .val { margin-top: 6px; font-size: 18px; font-weight: 700; letter-spacing:.2px; }
    .kpiBtn .hint { margin-top: 6px; color: var(--muted); font-size: 11px; }
    .kpiBtn .more { margin-top: 8px; color: #cfe0ff; font-size: 11px; opacity:.9; }

    .detailCard { margin-bottom: 14px; }
    .detailGrid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 900px) { .detailGrid { grid-template-columns: 1fr; } }

    .miniCard {
      border:1px solid rgba(29,42,71,.65);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      padding: 10px 12px;
    }
    .miniCard .t { color:#cfe0ff; font-size: 12px; margin-bottom: 8px; }
    .kv { display:flex; justify-content:space-between; gap:12px; padding: 6px 0; border-top:1px solid rgba(29,42,71,.45); font-size: 12px; }
    .kv:first-child { border-top:none; padding-top: 0; }
    .kv .k { color: var(--muted); }
    .kv .v { color: #dfe8ff; font-variant-numeric: tabular-nums; }

    .row {
      display:grid;
      grid-template-columns: 1fr 170px;
      gap: 10px;
      align-items:center;
      padding: 10px 0;
      border-top: 1px solid rgba(29,42,71,.55);
    }
    .row:first-of-type { border-top: none; padding-top: 4px; }
    .lbl { font-size: 12px; color: #cfe0ff; }
    .unit { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .ctl {
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    input[type="number"] {
      width: 96px;
      padding: 8px 8px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      font-size: 12px;
    }
    input[type="range"] { width: 170px; accent-color: var(--accent); }

    details {
      border:1px solid rgba(29,42,71,.65);
      border-radius: 14px;
      background: rgba(255,255,255,.02);
      padding: 10px 12px;
      margin-top: 10px;
    }
    details > summary {
      cursor: pointer;
      color: #cfe0ff;
      font-size: 12px;
      list-style: none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    details > summary::-webkit-details-marker { display:none; }
    .mini { color: var(--muted); font-size: 11px; }

    .rampGrid {
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    @media (max-width: 520px) { .rampGrid { grid-template-columns: repeat(3, 1fr); } }
    .rampCell {
      border:1px solid rgba(29,42,71,.65);
      border-radius: 12px;
      padding: 8px;
      background: rgba(0,0,0,.18);
    }
    .rampCell .y { color: var(--muted); font-size: 11px; }
    .rampCell input { width: 100%; margin-top: 6px; }

    .charts { display:grid; grid-template-columns: 1fr; gap: 12px; }
    .chartBox { height: 320px; padding: 10px 10px 4px; }

    .tableWrap {
      overflow:auto;
      max-height: 420px;
      border-radius: 14px;
      border:1px solid rgba(29,42,71,.65);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 860px;
      background: rgba(0,0,0,.18);
    }
    thead th {
      position: sticky;
      top: 0;
      background: rgba(16,26,46,.95);
      border-bottom: 1px solid rgba(29,42,71,.85);
      color: #cfe0ff;
      font-size: 12px;
      text-align: right;
      padding: 10px 10px;
      white-space:nowrap;
    }
    thead th:first-child, tbody td:first-child { text-align:left; }
    tbody td {
      border-bottom: 1px solid rgba(29,42,71,.55);
      color: #dfe8ff;
      font-size: 12px;
      padding: 9px 10px;
      text-align: right;
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
    }
    .note {
      color: var(--muted);
      font-size: 11px;
      margin-top: 10px;
      line-height: 1.55;
    }
    .tag {
      display:inline-block;
      padding: 2px 8px;
      border-radius:999px;
      border:1px solid rgba(29,42,71,.85);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 11px;
      margin-left: 6px;
    }
    .btn {
      cursor:pointer;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 8px 10px;
      font-size: 12px;
    }
    .btn:hover { background: rgba(255,255,255,.07); }

    .groupTitle {
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin: 8px 0 4px;
    }
    .groupTitle .g { color:#cfe0ff; font-size: 12px; }
    .groupTitle .d { color: var(--muted); font-size: 11px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>äº‘å’–åº„å›­ç§æ¤é¡¹ç›®ï½œç°é‡‘æµæµ‹ç®—çœ‹æ¿</h1>
        <div class="sub">
          æ»‘è½¨è°ƒæ•´å…³é”®å˜é‡ï¼Œè‡ªåŠ¨é‡ç®—ï¼šç°é‡‘æµã€å›æœ¬ã€NPV/IRRã€å³°å€¼èµ„é‡‘éœ€æ±‚ã€‚<span class="tag">æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´å‚æ•°</span>
        </div>
      </div>
      <div class="pill"><span>ğŸ”¥é¡¹ç›®å¤§å‰ğŸ”¥</span><span>ï½œ</span><span>ğŸ›«å¼€å·¥èµ·é£ğŸ›«</span></div>
    </header>

    <div class="kpis">
      <button class="kpiBtn active" id="kpiCapexBtn" data-panel="capex" type="button">
        <div class="label">æ€»CAPEXï¼ˆå«é¢„å¤‡è´¹ï¼‰</div>
        <div class="val" id="kpiCapex">â€”</div>
        <div class="hint">Year1 + æ›´æ¢/è¡¥æ¤</div>
        <div class="more">ç‚¹å‡»å±•å¼€æ˜ç»†</div>
      </button>

      <button class="kpiBtn" id="kpiPeakBtn" data-panel="peak" type="button">
        <div class="label">å³°å€¼èµ„é‡‘éœ€æ±‚</div>
        <div class="val" id="kpiPeak">â€”</div>
        <div class="hint">ç´¯è®¡ç°é‡‘æµæœ€ä½ç‚¹</div>
        <div class="more">ç‚¹å‡»å±•å¼€æ˜ç»†</div>
      </button>

      <button class="kpiBtn" id="kpiPaybackBtn" data-panel="payback" type="button">
        <div class="label">å›æœ¬å¹´</div>
        <div class="val" id="kpiPayback">â€”</div>
        <div class="hint">ç´¯è®¡FCF â‰¥ 0</div>
        <div class="more">ç‚¹å‡»å±•å¼€æ˜ç»†</div>
      </button>

      <button class="kpiBtn" id="kpiIrrBtn" data-panel="irr" type="button">
        <div class="label">IRR / NPV</div>
        <div class="val" id="kpiIrrNpv">â€”</div>
        <div class="hint">ç¨åè‡ªç”±ç°é‡‘æµ</div>
        <div class="more">ç‚¹å‡»å±•å¼€æ˜ç»†</div>
      </button>
    </div>

    <div class="card detailCard">
      <h2 id="detailTitle">æ€»CAPEX æ˜ç»†</h2>
      <div id="detailBody"></div>
      <div class="note" id="detailNote"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>å‚æ•°è¾“å…¥ï¼ˆæŒ‰å£å¾„å½’ç±»ï¼‰</h2>

        <div id="inputArea"></div>

        <details open>
          <summary>
            <span>äº§é‡çˆ¬å¡ï¼ˆé€å¹´æ»¡äº§æ¯”ä¾‹ï¼‰</span>
            <span class="mini">æ”¹æ¯ä¸€å¹´ 0~1</span>
          </summary>
          <div class="rampGrid" id="rampGrid"></div>
        </details>

        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
          <button class="btn" id="btnReset" type="button">ä¸€é”®æ¢å¤é»˜è®¤å€¼</button>
          <button class="btn" id="btnCopyJson" type="button">å¤åˆ¶å½“å‰å‚æ•°JSON</button>
        </div>

        <div class="note">
          å£å¾„ï¼š<b>ç¨åè‡ªç”±ç°é‡‘æµ FCF = æ”¶å…¥ - OPEX - æ‰€å¾—ç¨ - CAPEX</b>ï¼ˆæœªè®¡è¥è¿èµ„é‡‘ã€èèµ„ç»“æ„ã€è¡¥è´´ä¸åœŸåœ°èµ„äº§åŒ–ç­‰ï¼‰ã€‚<br/>
          å¦‚æœä½ èµ°â€œè‡ªå»ºå¤„ç†å‚/æ™’åœºâ€ï¼ŒæŠŠ <b>å¤„ç†å‚/æ™’åœº/ä»“å‚¨ CAPEX</b> è®¾ä¸ºé0ï¼Œå¹¶ç›¸åº”ä¸‹è°ƒ <b>åå¤„ç†/åˆ†çº§/ä»“å‚¨ï¼ˆå…ƒ/kgç”Ÿè±†ï¼‰</b>ã€‚
        </div>
      </div>

      <div class="card">
        <h2>ç»“æœå±•ç¤ºï¼ˆå›¾è¡¨ + æ˜ç»†è¡¨ï¼‰</h2>

        <div class="charts">
          <div class="card chartBox">
            <h2 style="margin-bottom:6px;">æ”¶å…¥ / OPEX / ç¨åFCF</h2>
            <canvas id="chartMain"></canvas>
          </div>
          <div class="card chartBox">
            <h2 style="margin-bottom:6px;">ç´¯è®¡ç°é‡‘æµ</h2>
            <canvas id="chartCum"></canvas>
          </div>
        </div>

        <div style="margin-top:12px;">
          <h2>å¹´åº¦æ˜ç»†è¡¨</h2>
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>å¹´</th>
                  <th>æ»¡äº§æ¯”ä¾‹</th>
                  <th>ç”Ÿè±†äº§é‡(kg)</th>
                  <th>åˆ°æ‰‹å•ä»·(å…ƒ/kg)</th>
                  <th>æ”¶å…¥(å…ƒ)</th>
                  <th>OPEX(å…ƒ)</th>
                  <th>CAPEX(å…ƒ)</th>
                  <th>ç¨(å…ƒ)</th>
                  <th>ç¨åFCF(å…ƒ)</th>
                  <th>ç´¯è®¡FCF(å…ƒ)</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>

        <div class="note">
          æŠ•èµ„äººæœ€å…³å¿ƒä¸‰ä»¶äº‹ï¼š<b>å³°å€¼åƒé’±</b>ã€<b>å›æœ¬é€Ÿåº¦</b>ã€<b>å‡è®¾æ˜¯å¦èƒ½å…‘ç°</b>ã€‚ä½ æŠŠå‡è®¾æ˜¾æ€§åŒ–ï¼Œä»–ä»¬å°±æ›´å®¹æ˜“ä¸‹åˆ¤æ–­ã€‚
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const DEFAULTS = {"areaMu": 200, "freshYieldPerMu": 300, "treesPerMu": 200, "freshToGreenRatio": 6, "lossRate": 0.05, "price0": 150, "priceGrowth": 0.03, "channelFee": 0.1, "survivalRate": 0.95, "replantY2": 0.03, "replantY3": 0.01, "seedlingPrice": 4.8, "transplantPerMu": 600, "terracePerMu": 800, "landPrepPerMu": 600, "baseFertPrice": 1.2, "baseFertKgPerMu": 240, "weedClothPerMu": 999, "weedClothCycle": 3, "irrigationPerMu": 1600, "irrigationMaintRate": 0.03, "poolPerSet": 15000, "poolMuPerSet": 200, "procFacilityCapex": 0, "vehicleCapex": 0, "contingency": 0.1, "rentPerMu": 240, "rentGrowth": 0.03, "mgmtPerMu": 900, "harvestPerKgFresh": 3, "postProcPerKgGreen": 6, "logisticsPerKgGreen": 2, "packSalesPerKgGreen": 5, "qcFixed": 30000, "overheadFixed": 50000, "opexInflation": 0.03, "discountRate": 0.12, "taxRate": 0.25, "depYears": 8, "depreciableShare": 0.85};
    const DEFAULT_RAMP = [0.0, 0.0, 0.05, 0.3, 0.7, 0.9, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0];
    const YEARS = 15;

    let state = JSON.parse(JSON.stringify(DEFAULTS));
    let ramp = DEFAULT_RAMP.slice();

    const INPUT_CONFIGS = {"areaMu": {"label": "ç§æ¤é¢ç§¯", "unit": "äº©", "min": 20, "max": 2000, "step": 10}, "freshYieldPerMu": {"label": "æ»¡äº§äº©äº§é²œæœ", "unit": "kg/äº©/å¹´", "min": 50, "max": 1200, "step": 10}, "freshToGreenRatio": {"label": "é²œæœ/ç”Ÿè±†æ¯”", "unit": "kgé²œæœ/kgç”Ÿè±†", "min": 4, "max": 10, "step": 0.1}, "lossRate": {"label": "æ¬¡å“/æŸè€—ç‡", "unit": "%", "min": 0, "max": 0.35, "step": 0.01, "pct": true}, "price0": {"label": "ç”Ÿè±†åŸºå‡†ä»·æ ¼", "unit": "å…ƒ/kgç”Ÿè±†", "min": 20, "max": 500, "step": 5}, "priceGrowth": {"label": "ä»·æ ¼å¹´å¢é•¿ç‡", "unit": "%", "min": -0.1, "max": 0.15, "step": 0.005, "pct": true}, "channelFee": {"label": "æ¸ é“è´¹/æŠ˜æ‰£", "unit": "%", "min": 0, "max": 0.4, "step": 0.01, "pct": true}, "rentPerMu": {"label": "åœŸåœ°æµè½¬è´¹", "unit": "å…ƒ/äº©/å¹´", "min": 0, "max": 3000, "step": 20}, "rentGrowth": {"label": "ç§Ÿé‡‘é€’å¢ç‡", "unit": "%", "min": 0, "max": 0.12, "step": 0.005, "pct": true}, "mgmtPerMu": {"label": "æ—¥å¸¸ç®¡ç†", "unit": "å…ƒ/äº©/å¹´", "min": 0, "max": 5000, "step": 50}, "harvestPerKgFresh": {"label": "é²œæœé‡‡åŠ ", "unit": "å…ƒ/kgé²œæœ", "min": 0, "max": 10, "step": 0.1}, "postProcPerKgGreen": {"label": "åå¤„ç†/åˆ†çº§/ä»“å‚¨", "unit": "å…ƒ/kgç”Ÿè±†", "min": 0, "max": 30, "step": 0.2}, "logisticsPerKgGreen": {"label": "è¿è¾“ç‰©æµ", "unit": "å…ƒ/kgç”Ÿè±†", "min": 0, "max": 15, "step": 0.2}, "packSalesPerKgGreen": {"label": "åŒ…è£…ä¸é”€å”®è´¹ç”¨", "unit": "å…ƒ/kgç”Ÿè±†", "min": 0, "max": 30, "step": 0.2}, "qcFixed": {"label": "å“æ§/è®¤è¯/æ£€æµ‹ï¼ˆå›ºå®šï¼‰", "unit": "å…ƒ/å¹´", "min": 0, "max": 300000, "step": 5000}, "overheadFixed": {"label": "ä¿é™©/è¡Œæ”¿/è´¢åŠ¡ï¼ˆå›ºå®šï¼‰", "unit": "å…ƒ/å¹´", "min": 0, "max": 500000, "step": 5000}, "opexInflation": {"label": "è¿è¥é€šèƒ€ç‡", "unit": "%", "min": 0, "max": 0.12, "step": 0.005, "pct": true}, "irrigationMaintRate": {"label": "æ°´è‚¥ç³»ç»Ÿå¹´ç»´æŠ¤è´¹ç‡", "unit": "%", "min": 0, "max": 0.12, "step": 0.005, "pct": true}, "discountRate": {"label": "æŠ˜ç°ç‡", "unit": "%", "min": 0.05, "max": 0.25, "step": 0.005, "pct": true}, "taxRate": {"label": "æ‰€å¾—ç¨ç‡", "unit": "%", "min": 0, "max": 0.35, "step": 0.01, "pct": true}, "depYears": {"label": "æŠ˜æ—§å¹´é™ï¼ˆå¯æŠ˜æ—§CAPEXï¼‰", "unit": "å¹´", "min": 3, "max": 20, "step": 1}, "depreciableShare": {"label": "å¯æŠ˜æ—§CAPEXå æ¯”", "unit": "%", "min": 0, "max": 1.0, "step": 0.01, "pct": true}, "seedlingPrice": {"label": "å¹¼è‹—å•ä»·", "unit": "å…ƒ/æ ª", "min": 0, "max": 20, "step": 0.1}, "treesPerMu": {"label": "æ¯äº©ç§æ¤æ ªæ•°", "unit": "æ ª/äº©", "min": 80, "max": 400, "step": 10}, "survivalRate": {"label": "é¦–å¹´æˆæ´»ç‡", "unit": "%", "min": 0.6, "max": 1.0, "step": 0.01, "pct": true}, "replantY2": {"label": "ç¬¬2å¹´è¡¥æ¤æ¯”ä¾‹", "unit": "%", "min": 0, "max": 0.2, "step": 0.01, "pct": true}, "replantY3": {"label": "ç¬¬3å¹´è¡¥æ¤æ¯”ä¾‹", "unit": "%", "min": 0, "max": 0.15, "step": 0.01, "pct": true}, "transplantPerMu": {"label": "ç§»æ ½è´¹ç”¨", "unit": "å…ƒ/äº©", "min": 0, "max": 5000, "step": 50}, "terracePerMu": {"label": "åœŸåœ°å¼€å°", "unit": "å…ƒ/äº©", "min": 0, "max": 12000, "step": 100}, "landPrepPerMu": {"label": "å›å¡«/æ•´åœ°", "unit": "å…ƒ/äº©", "min": 0, "max": 12000, "step": 100}, "baseFertPrice": {"label": "åº•è‚¥å•ä»·", "unit": "å…ƒ/kg", "min": 0, "max": 10, "step": 0.1}, "baseFertKgPerMu": {"label": "åº•è‚¥ç”¨é‡", "unit": "kg/äº©", "min": 0, "max": 1200, "step": 10}, "weedClothPerMu": {"label": "é˜²è‰å¸ƒ", "unit": "å…ƒ/äº©", "min": 0, "max": 4000, "step": 20}, "weedClothCycle": {"label": "é˜²è‰å¸ƒæ›´æ¢å‘¨æœŸ", "unit": "å¹´", "min": 1, "max": 6, "step": 1}, "irrigationPerMu": {"label": "æ°´è‚¥ç³»ç»Ÿ", "unit": "å…ƒ/äº©", "min": 0, "max": 8000, "step": 50}, "poolPerSet": {"label": "æ°´æ± /è“„æ°´è®¾æ–½ï¼ˆæ¯å¥—ï¼‰", "unit": "å…ƒ/å¥—", "min": 0, "max": 200000, "step": 1000}, "poolMuPerSet": {"label": "æ°´æ± è¦†ç›–é¢ç§¯", "unit": "äº©/å¥—", "min": 20, "max": 800, "step": 10}, "procFacilityCapex": {"label": "å¤„ç†å‚/æ™’åœº/ä»“å‚¨ CAPEX", "unit": "å…ƒ", "min": 0, "max": 20000000, "step": 50000}, "vehicleCapex": {"label": "è½¦è¾†/è®¾å¤‡ CAPEX", "unit": "å…ƒ", "min": 0, "max": 8000000, "step": 50000}, "contingency": {"label": "é¢„å¤‡è´¹ï¼ˆContingencyï¼‰", "unit": "%", "min": 0, "max": 0.25, "step": 0.01, "pct": true}};
    const GROUPS = [["æ”¶å…¥ä¸äº§é‡", "æ ¸å¿ƒæ”¶å…¥å‡è®¾ï¼ˆäº§é‡Ã—ä»·æ ¼Ã—å…‘ç°ï¼‰", ["areaMu", "freshYieldPerMu", "freshToGreenRatio", "lossRate", "price0", "priceGrowth", "channelFee"]], ["CAPEXï¼ˆä¸€æ¬¡æ€§æŠ•èµ„ï¼‰", "åœŸåœ°+ç§æ¤+åŸºç¡€è®¾æ–½ï¼ˆå«é¢„å¤‡è´¹ï¼‰", ["seedlingPrice", "treesPerMu", "survivalRate", "replantY2", "replantY3", "transplantPerMu", "terracePerMu", "landPrepPerMu", "baseFertPrice", "baseFertKgPerMu", "weedClothPerMu", "weedClothCycle", "irrigationPerMu", "poolPerSet", "poolMuPerSet", "procFacilityCapex", "vehicleCapex", "contingency"]], ["OPEXï¼ˆå¹´åº¦è¿è¥ï¼‰", "ç§Ÿé‡‘/äººå·¥/é‡‡æ”¶/å¤„ç†/æ¸ é“ï¼ˆå«é€šèƒ€ï¼‰", ["rentPerMu", "rentGrowth", "mgmtPerMu", "harvestPerKgFresh", "postProcPerKgGreen", "logisticsPerKgGreen", "packSalesPerKgGreen", "qcFixed", "overheadFixed", "opexInflation", "irrigationMaintRate"]], ["è´¢åŠ¡ä¸ç¨", "æŠ˜ç°ã€ç¨ç‡ã€æŠ˜æ—§å£å¾„", ["discountRate", "taxRate", "depYears", "depreciableShare"]]];

    function fmtMoney(x) {
      if (x === null || x === undefined || Number.isNaN(x)) return "â€”";
      const sign = x < 0 ? "-" : "";
      x = Math.abs(x);
      if (x >= 1e8) return sign + (x/1e8).toFixed(2) + " äº¿";
      if (x >= 1e4) return sign + (x/1e4).toFixed(2) + " ä¸‡";
      return sign + x.toFixed(0);
    }
    function fmtPct(x) {
      if (x === null || x === undefined || Number.isNaN(x)) return "â€”";
      return (x*100).toFixed(1) + "%";
    }
    function clamp(v, a, b) { return Math.min(b, Math.max(a, v)); }

    function npv(rate, cashflows) {
      let s = 0;
      for (let i=0; i<cashflows.length; i++) {
        const t = i+1;
        s += cashflows[i] / Math.pow(1+rate, t);
      }
      return s;
    }

    function irrBisection(cashflows) {
      let hasPos = cashflows.some(x=>x>0);
      let hasNeg = cashflows.some(x=>x<0);
      if (!hasPos || !hasNeg) return null;

      let lo = -0.9, hi = 2.0;
      let fLo = npv(lo, cashflows);
      let fHi = npv(hi, cashflows);

      let tries = 0;
      while (fLo * fHi > 0 && tries < 20) {
        hi += 1.0;
        fHi = npv(hi, cashflows);
        tries++;
      }
      if (fLo * fHi > 0) return null;

      for (let it=0; it<80; it++) {
        const mid = (lo+hi)/2;
        const fMid = npv(mid, cashflows);
        if (Math.abs(fMid) < 1e-6) return mid;
        if (fLo * fMid <= 0) { hi = mid; fHi = fMid; }
        else { lo = mid; fLo = fMid; }
      }
      return (lo+hi)/2;
    }

    function computeModel() {
      const s = state;

      // --- Year1 CAPEX components ---
      const seedlingsY1 = s.areaMu * s.treesPerMu * s.seedlingPrice;
      const transplant = s.areaMu * s.transplantPerMu;
      const terrace = s.areaMu * s.terracePerMu;
      const landPrep = s.areaMu * s.landPrepPerMu;
      const baseFert = s.areaMu * s.baseFertKgPerMu * s.baseFertPrice;
      const weedClothY1 = s.areaMu * s.weedClothPerMu;
      const irrigation = s.areaMu * s.irrigationPerMu;

      const poolSets = (s.poolMuPerSet > 0) ? Math.ceil(s.areaMu / s.poolMuPerSet) : 0;
      const pools = poolSets * s.poolPerSet;

      const capexFixed = s.procFacilityCapex + s.vehicleCapex;

      const capexY1_raw = seedlingsY1 + transplant + terrace + landPrep + baseFert + weedClothY1 + irrigation + pools + capexFixed;
      const capexY1_cont = capexY1_raw * s.contingency;
      const capexY1 = capexY1_raw + capexY1_cont;

      const irrigationCapexTotal = irrigation; // ç”¨äºæŒ‰capexæ¯”ä¾‹è®¡ç»´æŠ¤è´¹

      const capex = new Array(YEARS).fill(0);
      capex[0] = capexY1;

      // Recurring CAPEX
      const replantY2_raw = s.areaMu * s.treesPerMu * s.seedlingPrice * s.replantY2;
      const replantY3_raw = s.areaMu * s.treesPerMu * s.seedlingPrice * s.replantY3;
      capex[1] += replantY2_raw * (1 + s.contingency);
      capex[2] += replantY3_raw * (1 + s.contingency);

      const cycle = Math.max(1, Math.round(s.weedClothCycle));
      let weedClothRepl_total = 0;
      for (let y = 1 + cycle; y <= YEARS; y += cycle) {
        const val = (s.areaMu * s.weedClothPerMu) * (1 + s.contingency);
        capex[y-1] += val;
        weedClothRepl_total += val;
      }

      // Depreciation (straight-line on total CAPEX * share)
      const totalCapexNominal = capex.reduce((a,b)=>a+b,0);
      const depreciable = totalCapexNominal * s.depreciableShare;

      const dep = new Array(YEARS).fill(0);
      const depYears = Math.max(1, Math.round(s.depYears));
      const depAnnual = depreciable / depYears;
      for (let i=0; i<Math.min(depYears, YEARS); i++) dep[i] = depAnnual;

      // Annual cashflow rows (also keep breakdown for peak/payback explanation)
      const rows = [];
      const fcfArr = [];
      let cum = 0;

      for (let i=0; i<YEARS; i++) {
        const year = i+1;
        const rampPct = clamp(Number(ramp[i] ?? 0), 0, 1);

        const freshKg = s.areaMu * s.freshYieldPerMu * rampPct;
        const greenKg = (freshKg / s.freshToGreenRatio) * (1 - s.lossRate);

        const price = s.price0 * Math.pow(1 + s.priceGrowth, i);
        const netPrice = price * (1 - s.channelFee);
        const revenue = greenKg * netPrice;

        const infl = Math.pow(1 + s.opexInflation, i);
        const rent = s.areaMu * s.rentPerMu * Math.pow(1 + s.rentGrowth, i);
        const mgmt = s.areaMu * s.mgmtPerMu * infl;

        const harvest = freshKg * s.harvestPerKgFresh;
        const post = greenKg * s.postProcPerKgGreen;
        const logistics = greenKg * s.logisticsPerKgGreen;
        const packSales = greenKg * s.packSalesPerKgGreen;

        const fixedQc = s.qcFixed * infl;
        const fixedOverhead = s.overheadFixed * infl;
        const maint = irrigationCapexTotal * s.irrigationMaintRate * infl;

        const opex = rent + mgmt + harvest + post + logistics + packSales + fixedQc + fixedOverhead + maint;

        const ebit = revenue - opex - dep[i];
        const tax = Math.max(0, ebit) * s.taxRate;

        const fcf = revenue - opex - tax - capex[i];
        cum += fcf;

        rows.push({
          year, rampPct, greenKg, netPrice,
          revenue, opex, capex: capex[i], tax, fcf, cum,
          // for explain
          opexBreakdown: {
            rent, mgmt, harvest, post, logistics, packSales, fixedQc, fixedOverhead, maint
          },
          capexYear: capex[i]
        });
        fcfArr.push(fcf);
      }

      const NPV = npv(s.discountRate, fcfArr);
      const IRR = irrBisection(fcfArr);

      const minRow = rows.reduce((a,b)=> (b.cum < a.cum ? b : a), rows[0]);
      const peakFunding = minRow.cum < 0 ? -minRow.cum : 0;

      const paybackRow = rows.find(r => r.cum >= 0) || null;

      const capexBreakdown = {
        year1: {
          "å¹¼è‹—ï¼ˆYear1ï¼‰": seedlingsY1,
          "ç§»æ ½": transplant,
          "åœŸåœ°å¼€å°": terrace,
          "å›å¡«/æ•´åœ°": landPrep,
          "åº•è‚¥": baseFert,
          "é˜²è‰å¸ƒï¼ˆYear1ï¼‰": weedClothY1,
          "æ°´è‚¥ç³»ç»Ÿ": irrigation,
          "æ°´æ± /è“„æ°´è®¾æ–½": pools,
          "å¤„ç†å‚/æ™’åœº/ä»“å‚¨ CAPEX": s.procFacilityCapex,
          "è½¦è¾†/è®¾å¤‡ CAPEX": s.vehicleCapex,
          "é¢„å¤‡è´¹ï¼ˆYear1ï¼‰": capexY1_cont
        },
        recurring: {
          "è¡¥æ¤ï¼ˆYear2ï¼‰": replantY2_raw * (1 + s.contingency),
          "è¡¥æ¤ï¼ˆYear3ï¼‰": replantY3_raw * (1 + s.contingency),
          "é˜²è‰å¸ƒæ›´æ¢ï¼ˆå‘¨æœŸï¼‰": weedClothRepl_total
        },
        total: totalCapexNominal,
        year1Total: capexY1,
        poolSets
      };

      // pick a representative OPEX year (first full production year, else year10)
      let rep = rows.find(r => r.rampPct >= 0.99) || rows[Math.min(9, YEARS-1)];
      const opexBreakdown = {
        year: rep.year,
        items: {
          "åœŸåœ°æµè½¬è´¹": rep.opexBreakdown.rent,
          "æ—¥å¸¸ç®¡ç†": rep.opexBreakdown.mgmt,
          "é²œæœé‡‡åŠ ": rep.opexBreakdown.harvest,
          "åå¤„ç†/åˆ†çº§/ä»“å‚¨": rep.opexBreakdown.post,
          "è¿è¾“ç‰©æµ": rep.opexBreakdown.logistics,
          "åŒ…è£…ä¸é”€å”®è´¹ç”¨": rep.opexBreakdown.packSales,
          "å“æ§/è®¤è¯/æ£€æµ‹": rep.opexBreakdown.fixedQc,
          "ä¿é™©/è¡Œæ”¿/è´¢åŠ¡": rep.opexBreakdown.fixedOverhead,
          "æ°´è‚¥ç³»ç»Ÿç»´æŠ¤": rep.opexBreakdown.maint
        },
        total: rep.opex
      };

      return {
        rows, fcfArr,
        capexTotal: totalCapexNominal,
        capexBreakdown,
        opexBreakdown,
        peakFunding,
        peakRow: minRow,
        paybackRow,
        NPV, IRR
      };
    }

    function renderInputs() {
      const root = document.getElementById("inputArea");
      root.innerHTML = "";

      GROUPS.forEach(([title, desc, keys], idx) => {
        const det = document.createElement("details");
        det.open = (idx === 0);
        det.innerHTML = `
          <summary>
            <span>${title}</span>
            <span class="mini">${desc}</span>
          </summary>
          <div class="sectionBody" id="group_${idx}"></div>
        `;
        root.appendChild(det);

        const body = det.querySelector(".sectionBody");
        keys.forEach(k => {
          const cfg = INPUT_CONFIGS[k];
          if (!cfg) return;

          const row = document.createElement("div");
          row.className = "row";

          const left = document.createElement("div");
          left.innerHTML = `<div class="lbl">${cfg.label}</div><div class="unit">${cfg.unit}</div>`;

          const right = document.createElement("div");
          right.className = "ctl";

          const slider = document.createElement("input");
          slider.type = "range";
          slider.min = cfg.min;
          slider.max = cfg.max;
          slider.step = cfg.step;
          slider.value = state[k];

          const num = document.createElement("input");
          num.type = "number";
          num.step = cfg.step;
          num.value = state[k];

          function syncFrom(v) {
            let val = Number(v);
            if (Number.isNaN(val)) return;
            val = clamp(val, Number(cfg.min), Number(cfg.max));
            state[k] = val;
            slider.value = val;
            num.value = val;
            updateAll();
          }

          slider.addEventListener("input", e => syncFrom(e.target.value));
          num.addEventListener("change", e => syncFrom(e.target.value));

          right.appendChild(slider);
          right.appendChild(num);

          row.appendChild(left);
          row.appendChild(right);
          body.appendChild(row);
        });
      });
    }

    function renderRamp() {
      const root = document.getElementById("rampGrid");
      root.innerHTML = "";
      for (let i=0; i<YEARS; i++) {
        const cell = document.createElement("div");
        cell.className = "rampCell";

        const y = document.createElement("div");
        y.className = "y";
        y.textContent = `ç¬¬${i+1}å¹´`;

        const inp = document.createElement("input");
        inp.type = "number";
        inp.step = "0.01";
        inp.min = "0";
        inp.max = "1";
        inp.value = ramp[i];

        inp.addEventListener("change", e => {
          let v = Number(e.target.value);
          if (Number.isNaN(v)) v = 0;
          ramp[i] = clamp(v, 0, 1);
          e.target.value = ramp[i];
          updateAll();
        });

        cell.appendChild(y);
        cell.appendChild(inp);
        root.appendChild(cell);
      }
    }

    let chartMain = null;
    let chartCum = null;

    function updateCharts(model) {
      const labels = model.rows.map(r => "Y" + r.year);
      const rev = model.rows.map(r => r.revenue);
      const opex = model.rows.map(r => r.opex);
      const fcf = model.rows.map(r => r.fcf);
      const cum = model.rows.map(r => r.cum);

      const ctx1 = document.getElementById("chartMain");
      const ctx2 = document.getElementById("chartCum");

      const commonOpts = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: "#cfe0ff" } },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${fmtMoney(ctx.raw)}`
            }
          }
        },
        scales: {
          x: { ticks: { color: "#8ea0c4" }, grid: { color: "rgba(29,42,71,.45)" } },
          y: { ticks: { color: "#8ea0c4", callback: (v)=>fmtMoney(v) }, grid: { color: "rgba(29,42,71,.45)" } },
        }
      };

      if (!chartMain) {
        chartMain = new Chart(ctx1, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'æ”¶å…¥', data: rev, tension: .25 },
              { label: 'OPEX', data: opex, tension: .25 },
              { label: 'ç¨åFCF', data: fcf, tension: .25 },
            ]
          },
          options: commonOpts
        });
      } else {
        chartMain.data.labels = labels;
        chartMain.data.datasets[0].data = rev;
        chartMain.data.datasets[1].data = opex;
        chartMain.data.datasets[2].data = fcf;
        chartMain.update();
      }

      if (!chartCum) {
        chartCum = new Chart(ctx2, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'ç´¯è®¡FCF', data: cum, tension: .25 }
            ]
          },
          options: commonOpts
        });
      } else {
        chartCum.data.labels = labels;
        chartCum.data.datasets[0].data = cum;
        chartCum.update();
      }
    }

    function updateTable(rows) {
      const tb = document.getElementById("tbody");
      tb.innerHTML = rows.map(r => `
        <tr>
          <td>Y${r.year}</td>
          <td>${(r.rampPct*100).toFixed(0)}%</td>
          <td>${r.greenKg.toFixed(0)}</td>
          <td>${r.netPrice.toFixed(1)}</td>
          <td>${fmtMoney(r.revenue)}</td>
          <td>${fmtMoney(r.opex)}</td>
          <td>${fmtMoney(r.capex)}</td>
          <td>${fmtMoney(r.tax)}</td>
          <td>${fmtMoney(r.fcf)}</td>
          <td>${fmtMoney(r.cum)}</td>
        </tr>
      `).join("");
    }

    function updateKPIs(model) {
      document.getElementById("kpiCapex").textContent = fmtMoney(model.capexTotal);
      document.getElementById("kpiPeak").textContent = fmtMoney(model.peakFunding);
      document.getElementById("kpiPayback").textContent = model.paybackRow ? ("Y" + model.paybackRow.year) : "æœªå›æœ¬";

      const irrTxt = model.IRR === null ? "â€”" : fmtPct(model.IRR);
      const npvTxt = fmtMoney(model.NPV);
      document.getElementById("kpiIrrNpv").textContent = `${irrTxt} / ${npvTxt}`;
    }

    function kvList(obj) {
      const entries = Object.entries(obj).filter(([k,v]) => (v !== null && v !== undefined && !Number.isNaN(v)));
      return entries.map(([k,v]) => `
        <div class="kv">
          <div class="k">${k}</div>
          <div class="v">${fmtMoney(v)}</div>
        </div>
      `).join("");
    }

    function renderDetail(panel, model) {
      const title = document.getElementById("detailTitle");
      const body = document.getElementById("detailBody");
      const note = document.getElementById("detailNote");

      if (panel === "capex") {
        title.textContent = "æ€»CAPEX æ˜ç»†";
        const y1 = model.capexBreakdown.year1;
        const rec = model.capexBreakdown.recurring;

        body.innerHTML = `
          <div class="detailGrid">
            <div class="miniCard">
              <div class="t">Year 1 CAPEXï¼ˆå«é¢„å¤‡è´¹ï¼‰</div>
              ${kvList(y1)}
              <div class="kv"><div class="k">Year 1 å°è®¡</div><div class="v">${fmtMoney(model.capexBreakdown.year1Total)}</div></div>
            </div>
            <div class="miniCard">
              <div class="t">åç»­CAPEXï¼ˆæ›´æ¢/è¡¥æ¤ï¼‰</div>
              ${kvList(rec)}
              <div class="kv"><div class="k">åç»­CAPEXå°è®¡</div><div class="v">${fmtMoney(Object.values(rec).reduce((a,b)=>a+(b||0),0))}</div></div>
              <div class="kv"><div class="k">æ€»CAPEX</div><div class="v">${fmtMoney(model.capexTotal)}</div></div>
            </div>
          </div>
        `;
        note.textContent = `æ°´æ± æŒ‰ ${model.capexBreakdown.poolSets} å¥—ä¼°ç®—ï¼ˆé¢ç§¯/å¥—å¯è°ƒï¼‰ã€‚é¢„å¤‡è´¹æŒ‰â€œå„é¡¹Ã—é¢„å¤‡è´¹%â€è¿›å…¥CAPEXã€‚`;
        return;
      }

      if (panel === "peak") {
        title.textContent = "å³°å€¼èµ„é‡‘éœ€æ±‚ æ˜ç»†";
        const r = model.peakRow;
        // show 6 years around peak
        const i = r.year - 1;
        const from = Math.max(0, i-3);
        const to = Math.min(YEARS-1, i+2);
        const seg = model.rows.slice(from, to+1).map(x => ({
          y: x.year, fcf: x.fcf, cum: x.cum, capex:x.capex, opex:x.opex, revenue:x.revenue
        }));

        body.innerHTML = `
          <div class="detailGrid">
            <div class="miniCard">
              <div class="t">å³°å€¼èµ„é‡‘éœ€æ±‚</div>
              <div class="kv"><div class="k">å³°å€¼èµ„é‡‘éœ€æ±‚ï¼ˆç´¯è®¡æœ€ä½ç‚¹ï¼‰</div><div class="v">${fmtMoney(model.peakFunding)}</div></div>
              <div class="kv"><div class="k">å‘ç”Ÿå¹´ä»½</div><div class="v">Y${r.year}</div></div>
              <div class="kv"><div class="k">è¯¥å¹´ç¨åFCF</div><div class="v">${fmtMoney(r.fcf)}</div></div>
              <div class="kv"><div class="k">è¯¥å¹´CAPEX</div><div class="v">${fmtMoney(r.capex)}</div></div>
              <div class="kv"><div class="k">è¯¥å¹´OPEX</div><div class="v">${fmtMoney(r.opex)}</div></div>
              <div class="kv"><div class="k">è¯¥å¹´æ”¶å…¥</div><div class="v">${fmtMoney(r.revenue)}</div></div>
            </div>
            <div class="miniCard">
              <div class="t">å³°å€¼å‰åï¼ˆèŠ‚é€‰ï¼‰</div>
              ${
                seg.map(s=>`
                  <div class="kv">
                    <div class="k">Y${s.y}ï¼šFCF / ç´¯è®¡</div>
                    <div class="v">${fmtMoney(s.fcf)} / ${fmtMoney(s.cum)}</div>
                  </div>
                `).join("")
              }
            </div>
          </div>
        `;
        note.textContent = "å³°å€¼èµ„é‡‘éœ€æ±‚æ¯”â€œæ€»æŠ•èµ„â€æ›´å…³é”®ï¼šå®ƒå†³å®šä½ åœ¨æœ€éš¾ç†¬é˜¶æ®µéœ€è¦å‡†å¤‡å¤šå°‘ç°é‡‘/èèµ„é¢åº¦ã€‚";
        return;
      }

      if (panel === "payback") {
        title.textContent = "å›æœ¬å¹´ æ˜ç»†";
        const pb = model.paybackRow;
        if (!pb) {
          body.innerHTML = `<div class="miniCard"><div class="t">æœªå›æœ¬</div><div class="note">åœ¨å½“å‰å‡è®¾ä¸‹ï¼Œ15å¹´å†…ç´¯è®¡ç°é‡‘æµæœªè½¬æ­£ã€‚</div></div>`;
          note.textContent = "";
          return;
        }
        const i = pb.year - 1;
        const from = Math.max(0, i-3);
        const to = Math.min(YEARS-1, i+3);
        const seg = model.rows.slice(from, to+1).map(x => ({
          y: x.year, fcf: x.fcf, cum: x.cum
        }));

        body.innerHTML = `
          <div class="detailGrid">
            <div class="miniCard">
              <div class="t">å›æœ¬ç»“è®º</div>
              <div class="kv"><div class="k">å›æœ¬å¹´</div><div class="v">Y${pb.year}</div></div>
              <div class="kv"><div class="k">å›æœ¬å½“å¹´ç´¯è®¡</div><div class="v">${fmtMoney(pb.cum)}</div></div>
              <div class="kv"><div class="k">å›æœ¬å½“å¹´FCF</div><div class="v">${fmtMoney(pb.fcf)}</div></div>
            </div>
            <div class="miniCard">
              <div class="t">å›æœ¬å‰åï¼ˆèŠ‚é€‰ï¼‰</div>
              ${
                seg.map(s=>`
                  <div class="kv">
                    <div class="k">Y${s.y}ï¼šFCF / ç´¯è®¡</div>
                    <div class="v">${fmtMoney(s.fcf)} / ${fmtMoney(s.cum)}</div>
                  </div>
                `).join("")
              }
            </div>
          </div>
        `;
        note.textContent = "å›æœ¬å¹´å—ä¸¤ä»¶äº‹æ”¯é…ï¼šâ‘ æŠ•äº§çˆ¬å¡æ˜¯å¦å…‘ç°ï¼›â‘¡åˆ°æ‰‹å•ä»·ï¼ˆä»·æ ¼Ã—æ¸ é“è´¹ï¼‰èƒ½å¦æŒç»­ã€‚";
        return;
      }

      if (panel === "irr") {
        title.textContent = "IRR / NPV æ˜ç»†";
        const irrTxt = model.IRR === null ? "â€”" : fmtPct(model.IRR);
        body.innerHTML = `
          <div class="detailGrid">
            <div class="miniCard">
              <div class="t">æŒ‡æ ‡å£å¾„</div>
              <div class="kv"><div class="k">æŠ˜ç°ç‡ï¼ˆç”¨äºNPVï¼‰</div><div class="v">${fmtPct(state.discountRate)}</div></div>
              <div class="kv"><div class="k">æ‰€å¾—ç¨ç‡</div><div class="v">${fmtPct(state.taxRate)}</div></div>
              <div class="kv"><div class="k">IRR</div><div class="v">${irrTxt}</div></div>
              <div class="kv"><div class="k">NPV</div><div class="v">${fmtMoney(model.NPV)}</div></div>
            </div>
            <div class="miniCard">
              <div class="t">ä»£è¡¨æ€§å¹´åº¦OPEXæ‹†è§£ï¼ˆY${model.opexBreakdown.year}ï¼‰</div>
              ${kvList(model.opexBreakdown.items)}
              <div class="kv"><div class="k">OPEXå°è®¡</div><div class="v">${fmtMoney(model.opexBreakdown.total)}</div></div>
            </div>
          </div>
        `;
        note.textContent = "IRRå¯¹â€œäº§é‡Ã—ä»·æ ¼Ã—å…‘ç°â€çš„æ•æ„Ÿåº¦é€šå¸¸è¿œé«˜äºå¯¹å°‘æ•°ç»†é¡¹æˆæœ¬çš„æ•æ„Ÿåº¦ï¼›ä½ å¯ä»¥ç”¨æ»‘è½¨æŠŠæŠ•èµ„äººæœ€æ€€ç–‘çš„å‡è®¾æ‹‰åˆ°æç«¯ï¼Œçœ‹é¡¹ç›®æ˜¯å¦è¿˜èƒ½ç«™å¾—ä½ã€‚";
        return;
      }
    }

    function setActivePanel(panel, model) {
      document.querySelectorAll(".kpiBtn").forEach(b => {
        b.classList.toggle("active", b.dataset.panel === panel);
      });
      renderDetail(panel, model);
    }

    function updateAll() {
      const model = computeModel();
      updateKPIs(model);
      updateTable(model.rows);
      updateCharts(model);
      // keep current active panel
      const activeBtn = document.querySelector(".kpiBtn.active") || document.getElementById("kpiCapexBtn");
      setActivePanel(activeBtn.dataset.panel, model);
    }

    function updateCharts(model) {
      const labels = model.rows.map(r => "Y" + r.year);
      const rev = model.rows.map(r => r.revenue);
      const opex = model.rows.map(r => r.opex);
      const fcf = model.rows.map(r => r.fcf);
      const cum = model.rows.map(r => r.cum);

      const ctx1 = document.getElementById("chartMain");
      const ctx2 = document.getElementById("chartCum");

      const commonOpts = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: "#cfe0ff" } },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${fmtMoney(ctx.raw)}`
            }
          }
        },
        scales: {
          x: { ticks: { color: "#8ea0c4" }, grid: { color: "rgba(29,42,71,.45)" } },
          y: { ticks: { color: "#8ea0c4", callback: (v)=>fmtMoney(v) }, grid: { color: "rgba(29,42,71,.45)" } },
        }
      };

      if (!chartMain) {
        chartMain = new Chart(ctx1, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'æ”¶å…¥', data: rev, tension: .25 },
              { label: 'OPEX', data: opex, tension: .25 },
              { label: 'ç¨åFCF', data: fcf, tension: .25 },
            ]
          },
          options: commonOpts
        });
      } else {
        chartMain.data.labels = labels;
        chartMain.data.datasets[0].data = rev;
        chartMain.data.datasets[1].data = opex;
        chartMain.data.datasets[2].data = fcf;
        chartMain.update();
      }

      if (!chartCum) {
        chartCum = new Chart(ctx2, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'ç´¯è®¡FCF', data: cum, tension: .25 }
            ]
          },
          options: commonOpts
        });
      } else {
        chartCum.data.labels = labels;
        chartCum.data.datasets[0].data = cum;
        chartCum.update();
      }
    }

    // Buttons
    document.getElementById("btnReset").addEventListener("click", () => {
      state = JSON.parse(JSON.stringify(DEFAULTS));
      ramp = DEFAULT_RAMP.slice();
      renderInputs();
      renderRamp();
      updateAll();
    });

    document.getElementById("btnCopyJson").addEventListener("click", async () => {
      const payload = { params: state, ramp };
      const txt = JSON.stringify(payload, null, 2);
      try {
        await navigator.clipboard.writeText(txt);
        alert("å·²å¤åˆ¶å½“å‰å‚æ•°JSON");
      } catch (e) {
        prompt("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š", txt);
      }
    });

    document.querySelectorAll(".kpiBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const model = computeModel();
        setActivePanel(btn.dataset.panel, model);
      });
    });

    // Init
    renderInputs();
    renderRamp();
    updateAll();
  </script>
</body>
</html>
